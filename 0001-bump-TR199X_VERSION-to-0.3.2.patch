From 9f3b1a6c7d8e4fa1b2c3d4e5f678901234567890 Mon Sep 17 00:00:00 2001
From: the-butterfry <the-butterfry@users.noreply.github.com>
Date: Thu, 11 Sep 2025 01:21:09 +0000
Subject: [PATCH] Bump TR199X_VERSION to 0.3.2; robust nav toggle; add nav CSS

Make the nav toggle robust to either id or class markup, add a small
scoped CSS asset to hide the collapsed nav on small screens, and bump the
TR199X_VERSION constant so enqueued assets are cache-busted.

Files changed:
- assets/js/main.js (replaced)
- assets/css/tr199x-nav.css (new)
- functions.php (version bump)
---
 assets/js/main.js            |  114 ++++++++++++++++++++++++++++++++++++++++++++++
 assets/css/tr199x-nav.css    |   12 ++++++++++++
 functions.php                |   2 +-
 3 files changed, 127 insertions(+), 1 deletion(-)
 create mode 100644 assets/css/tr199x-nav.css
--- a/assets/js/main.js
+++ b/assets/js/main.js
@@ -1,24 +1,114 @@
-// Retro 199X core JS: nav toggle + reduced motion flag
-(function(){
-  const navToggle = document.getElementById('tr-nav-toggle');
-  const nav = document.getElementById('tr-primary-nav');
-  if (navToggle && nav){
-    navToggle.addEventListener('click', ()=>{
-      nav.classList.toggle('tr-collapsed');
-      navToggle.setAttribute('aria-expanded', (!nav.classList.contains('tr-collapsed')).toString());
-    });
-    if (window.matchMedia('(max-width: 980px)').matches){
-      nav.classList.add('tr-collapsed');
-      navToggle.setAttribute('aria-expanded','false');
-    }
-  }
-  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
-    document.body.classList.add('prefers-reduced-motion');
-  }
-})();
+// Retro 199X core JS: nav toggle + reduced motion flag (robust selectors)
+(function(){
+  const navToggle = document.getElementById('tr-nav-toggle') || document.querySelector('.tr-nav-toggle');
+  const nav = document.getElementById('tr-primary-nav') || document.getElementById('site-navigation') || document.querySelector('.tr-nav');
+
+  if (navToggle && nav){
+    const setExpandedState = (expanded) => {
+      navToggle.setAttribute('aria-expanded', String(expanded));
+      // If aria-controls is missing, set it to the nav id to help assistive tech (non-destructive)
+      if (!navToggle.getAttribute('aria-controls') && nav.id) {
+        navToggle.setAttribute('aria-controls', nav.id);
+      }
+    };
+
+    const toggleNav = () => {
+      nav.classList.toggle('tr-collapsed');
+      setExpandedState(!nav.classList.contains('tr-collapsed'));
+    };
+
+    navToggle.addEventListener('click', (e) => {
+      e.preventDefault();
+      toggleNav();
+    });
+
+    // Initialize collapsed state based on viewport size
+    const mq = window.matchMedia('(max-width: 980px)');
+    const applyInitial = (m) => {
+      if (m.matches) {
+        nav.classList.add('tr-collapsed');
+        setExpandedState(false);
+      } else {
+        nav.classList.remove('tr-collapsed');
+        setExpandedState(true);
+      }
+    };
+
+    applyInitial(mq);
+    // Prefer addEventListener on MediaQueryList, fallback to addListener for older browsers
+    if (typeof mq.addEventListener === 'function') {
+      mq.addEventListener('change', (e) => applyInitial(e));
+    } else if (typeof mq.addListener === 'function') {
+      mq.addListener(applyInitial);
+    }
+  }
+
+  if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
+    document.body.classList.add('prefers-reduced-motion');
+  }
+})();
+
--- a/assets/css/tr199x-nav.css
+++ b/assets/css/tr199x-nav.css
@@ -0,0 +1,12 @@
+/* Scoped CSS to hide collapsed nav on small screens.
+   Add this file to theme assets and enqueue it, or import it from your main stylesheet.
+*/
+@media (max-width: 980px) {
+  .tr-header .tr-nav.tr-collapsed,
+  .tr-header #tr-primary-nav.tr-collapsed,
+  .tr-header #site-navigation.tr-collapsed {
+    display: none;
+  }
+}
--- a/functions.php
+++ b/functions.php
@@ -1,6 +1,6 @@
-if ( ! defined('TR199X_VERSION') ) {
-    define('TR199X_VERSION', '0.3.1');
-}
+if ( ! defined('TR199X_VERSION') ) {
+    define('TR199X_VERSION', '0.3.2');
+}
-- 
2.41.0
